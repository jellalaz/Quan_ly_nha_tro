# GI·∫¢I TH√çCH CHI TI·∫æT FILE USERS.PY

## üìã T·ªîNG QUAN
File `users.py` l√† file x·ª≠ l√Ω **qu·∫£n l√Ω th√¥ng tin ng∆∞·ªùi d√πng** trong h·ªá th·ªëng qu·∫£n l√Ω nh√† tr·ªç. File n√†y c√≥ 4 ch·ª©c nƒÉng ch√≠nh:
1. **Xem th√¥ng tin c√° nh√¢n** - L·∫•y th√¥ng tin user ƒëang ƒëƒÉng nh·∫≠p
2. **C·∫≠p nh·∫≠t th√¥ng tin c√° nh√¢n** - S·ª≠a h·ªç t√™n, email, s·ªë ƒëi·ªán tho·∫°i
3. **Xem danh s√°ch roles** - L·∫•y t·∫•t c·∫£ c√°c role trong h·ªá th·ªëng
4. **ƒê·ªïi m·∫≠t kh·∫©u** - Thay ƒë·ªïi m·∫≠t kh·∫©u cho user hi·ªán t·∫°i

---

## üì¶ C√ÅC TH∆Ø VI·ªÜN IMPORT

```python
from fastapi import APIRouter, Depends, HTTPException
```
- **APIRouter**: T·∫°o router ƒë·ªÉ ƒë·ªãnh nghƒ©a c√°c endpoint API
- **Depends**: Dependency injection - t·ª± ƒë·ªông cung c·∫•p tham s·ªë (database, user hi·ªán t·∫°i)
- **HTTPException**: N√©m l·ªói HTTP khi c√≥ v·∫•n ƒë·ªÅ

```python
from sqlalchemy.orm import Session
from sqlalchemy.exc import IntegrityError
```
- **Session**: ƒê·ªëi t∆∞·ª£ng ƒë·ªÉ thao t√°c v·ªõi database
- **IntegrityError**: L·ªói khi vi ph·∫°m r√†ng bu·ªôc database (email/phone tr√πng)

```python
from typing import List
```
- **List**: Ki·ªÉu d·ªØ li·ªáu danh s√°ch (d√πng cho response tr·∫£ v·ªÅ nhi·ªÅu items)

```python
from app.core.database import get_db
from app.core.security import get_current_active_user, verify_password, get_password_hash
from app.schemas.user import User, UserUpdate, Role, PasswordChange
from app.models.user import User as UserModel
from app.crud import user as user_crud
```
- **get_db**: H√†m l·∫•y k·∫øt n·ªëi database
- **get_current_active_user**: L·∫•y th√¥ng tin user ƒëang ƒëƒÉng nh·∫≠p t·ª´ JWT token
- **verify_password**: Ki·ªÉm tra m·∫≠t kh·∫©u c√≥ kh·ªõp v·ªõi hash kh√¥ng
- **get_password_hash**: Hash m·∫≠t kh·∫©u m·ªõi
- **User, UserUpdate, Role, PasswordChange**: C√°c schema ƒë·ªãnh nghƒ©a c·∫•u tr√∫c d·ªØ li·ªáu
- **UserModel**: Model database c·ªßa User (ƒë·ªïi t√™n ƒë·ªÉ tr√°nh tr√πng v·ªõi schema User)
- **user_crud**: Module ch·ª©a c√°c h√†m CRUD

---

## üë§ ENDPOINT 1: XEM TH√îNG TIN C√Å NH√ÇN

### ƒê·ªãnh nghƒ©a endpoint
```python
@router.get("/me", response_model=User)
async def read_users_me(
    current_user: UserModel = Depends(get_current_active_user),
    db: Session = Depends(get_db)
):
```

**Gi·∫£i th√≠ch:**
- `@router.get("/me")`: Endpoint GET t·∫°i ƒë∆∞·ªùng d·∫´n `/me`
- `response_model=User`: K·∫øt qu·∫£ tr·∫£ v·ªÅ c√≥ c·∫•u tr√∫c nh∆∞ model `User`
- `current_user: UserModel = Depends(get_current_active_user)`: T·ª± ƒë·ªông l·∫•y user t·ª´ JWT token
- `db: Session = Depends(get_db)`: T·ª± ƒë·ªông l·∫•y k·∫øt n·ªëi database

**Kh√¥ng c·∫ßn d·ªØ li·ªáu ƒë·∫ßu v√†o** - Ch·ªâ c·∫ßn g·ª≠i JWT token trong header:
```
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### Lu·ªìng x·ª≠ l√Ω

```python
# Ensure role is loaded
if not hasattr(current_user, 'role') or current_user.role is None:
    db.refresh(current_user, ['role'])
return current_user
```

**Gi·∫£i th√≠ch:**
1. Ki·ªÉm tra xem ƒë·ªëi t∆∞·ª£ng `current_user` ƒë√£ c√≥ th√¥ng tin `role` ch∆∞a
2. N·∫øu ch∆∞a, g·ªçi `db.refresh(current_user, ['role'])` ƒë·ªÉ load t·ª´ database
3. Tr·∫£ v·ªÅ to√†n b·ªô th√¥ng tin user

**C∆° ch·∫ø get_current_active_user** (t·ª´ `core/security.py`):
```python
async def get_current_active_user(current_user: User = Depends(get_current_user)):
    if not current_user.is_active:
        raise HTTPException(status_code=400, detail="Inactive user")
    return current_user
```
- L·∫•y user t·ª´ JWT token
- Ki·ªÉm tra `is_active = True`
- N·∫øu user b·ªã v√¥ hi·ªáu h√≥a ‚Üí Tr·∫£ l·ªói 400

### K·∫øt qu·∫£ tr·∫£ v·ªÅ (User)

**Schema User** (t·ª´ `schemas/user.py`):
```python
class User(UserBase):
    owner_id: int                      # ID ng∆∞·ªùi d√πng
    is_active: bool                    # Tr·∫°ng th√°i ho·∫°t ƒë·ªông
    created_at: datetime               # Th·ªùi gian t·∫°o t√†i kho·∫£n
    updated_at: datetime | None        # Th·ªùi gian c·∫≠p nh·∫≠t g·∫ßn nh·∫•t
    role: Role                         # Th√¥ng tin quy·ªÅn

class UserBase(BaseModel):
    fullname: str                      # H·ªç t√™n
    phone: str                         # S·ªë ƒëi·ªán tho·∫°i
    email: EmailStr                    # Email
```

**V√≠ d·ª• k·∫øt qu·∫£:**
```json
{
  "owner_id": 1,
  "fullname": "Nguy·ªÖn VƒÉn A",
  "phone": "0123456789",
  "email": "nguyenvana@example.com",
  "is_active": true,
  "created_at": "2025-10-27T10:30:00Z",
  "updated_at": "2025-10-27T15:45:00Z",
  "role": {
    "id": 1,
    "authority": "owner"
  }
}
```

---

## ‚úèÔ∏è ENDPOINT 2: C·∫¨P NH·∫¨T TH√îNG TIN C√Å NH√ÇN

### ƒê·ªãnh nghƒ©a endpoint
```python
@router.put("/me", response_model=User)
async def update_users_me(
    user_update: UserUpdate,
    db: Session = Depends(get_db),
    current_user: UserModel = Depends(get_current_active_user)
):
```

**Gi·∫£i th√≠ch:**
- `@router.put("/me")`: Endpoint PUT (c·∫≠p nh·∫≠t) t·∫°i `/me`
- `user_update: UserUpdate`: D·ªØ li·ªáu c·∫≠p nh·∫≠t t·ª´ client
- `current_user`: User ƒëang ƒëƒÉng nh·∫≠p (t·ª´ JWT token)

**D·ªØ li·ªáu ƒë·∫ßu v√†o (UserUpdate)** - T·ª´ file `schemas/user.py`:
```python
class UserUpdate(BaseModel):
    fullname: Optional[str] = None     # H·ªç t√™n m·ªõi (kh√¥ng b·∫Øt bu·ªôc)
    phone: Optional[str] = None        # SƒêT m·ªõi (kh√¥ng b·∫Øt bu·ªôc)
    email: Optional[EmailStr] = None   # Email m·ªõi (kh√¥ng b·∫Øt bu·ªôc)
```

**ƒê·∫∑c ƒëi·ªÉm:**
- T·∫•t c·∫£ c√°c field ƒë·ªÅu **Optional** (kh√¥ng b·∫Øt bu·ªôc)
- Ch·ªâ c·∫ßn g·ª≠i field mu·ªën c·∫≠p nh·∫≠t
- V·∫´n c√≥ validation t∆∞∆°ng t·ª± UserCreate (h·ªç t√™n >= 3 k√Ω t·ª±, phone 10-11 s·ªë)

**V√≠ d·ª• request body:**
```json
{
  "fullname": "Nguy·ªÖn VƒÉn B",
  "phone": "0987654321"
}
```
Ho·∫∑c ch·ªâ c·∫≠p nh·∫≠t 1 field:
```json
{
  "email": "newemail@example.com"
}
```

### B∆∞·ªõc 1: Ki·ªÉm tra email tr√πng l·∫∑p (n·∫øu ƒë·ªïi email)

```python
if user_update.email and user_update.email != current_user.email:
    if user_crud.get_user_by_email(db, email=user_update.email):
        raise HTTPException(status_code=400, detail="Email already registered")
```

**Gi·∫£i th√≠ch:**
- Ki·ªÉm tra n·∫øu user mu·ªën ƒë·ªïi email (c√≥ g·ª≠i email m·ªõi v√† kh√°c email hi·ªán t·∫°i)
- T√¨m trong database xem email m·ªõi ƒë√£ c√≥ ai d√πng ch∆∞a
- N·∫øu ƒë√£ t·ªìn t·∫°i ‚Üí Tr·∫£ l·ªói **400 Bad Request**

**T·∫°i sao ph·∫£i ki·ªÉm tra `user_update.email != current_user.email`?**
- N·∫øu user g·ª≠i l·∫°i email hi·ªán t·∫°i c·ªßa m√¨nh ‚Üí Kh√¥ng c·∫ßn ki·ªÉm tra tr√πng
- Ch·ªâ ki·ªÉm tra khi th·ª±c s·ª± mu·ªën ƒë·ªïi sang email kh√°c

### B∆∞·ªõc 2: Ki·ªÉm tra phone tr√πng l·∫∑p (n·∫øu ƒë·ªïi SƒêT)

```python
if user_update.phone and user_update.phone != current_user.phone:
    if user_crud.get_user_by_phone(db, phone=user_update.phone):
        raise HTTPException(status_code=400, detail="Phone already registered")
```

**Gi·∫£i th√≠ch:**
- T∆∞∆°ng t·ª± ki·ªÉm tra email
- Ki·ªÉm tra s·ªë ƒëi·ªán tho·∫°i m·ªõi c√≥ b·ªã tr√πng v·ªõi user kh√°c kh√¥ng

### B∆∞·ªõc 3: C·∫≠p nh·∫≠t th√¥ng tin

```python
try:
    updated = user_crud.update_user(db, current_user.owner_id, user_update)
    return updated
except IntegrityError:
    db.rollback()
    raise HTTPException(status_code=400, detail="Email or Phone already registered")
```

**Gi·∫£i th√≠ch:**
- G·ªçi h√†m `update_user` t·ª´ `crud/user.py`
- N·∫øu x·∫£y ra IntegrityError (v√≠ d·ª•: race condition - 2 request c√πng l√∫c) ‚Üí Rollback v√† b√°o l·ªói
- Tr·∫£ v·ªÅ th√¥ng tin user ƒë√£ c·∫≠p nh·∫≠t

**Chi ti·∫øt h√†m update_user** (t·ª´ `crud/user.py`):
```python
def update_user(db: Session, user_id: int, user_update: UserUpdate):
    db_user = get_user_by_id(db, user_id)          # T√¨m user theo ID
    if db_user:
        update_data = user_update.dict(exclude_unset=True)  # Ch·ªâ l·∫•y field c√≥ gi√° tr·ªã
        for field, value in update_data.items():
            setattr(db_user, field, value)          # C·∫≠p nh·∫≠t t·ª´ng field
        db.commit()                                 # L∆∞u v√†o database
        db.refresh(db_user)                         # L√†m m·ªõi object
    return db_user
```

**L∆∞u √Ω `exclude_unset=True`:**
- Ch·ªâ l·∫•y c√°c field m√† user th·ª±c s·ª± g·ª≠i l√™n
- V√≠ d·ª•: N·∫øu ch·ªâ g·ª≠i `{"fullname": "New Name"}` ‚Üí Ch·ªâ c·∫≠p nh·∫≠t fullname, kh√¥ng ƒë·ªông email/phone

### K·∫øt qu·∫£ tr·∫£ v·ªÅ
- Tr·∫£ v·ªÅ th√¥ng tin user ƒë√£ c·∫≠p nh·∫≠t (schema `User`)
- Gi·ªëng nh∆∞ k·∫øt qu·∫£ c·ªßa endpoint `/me`

---

## üîë ENDPOINT 3: XEM DANH S√ÅCH ROLES

### ƒê·ªãnh nghƒ©a endpoint
```python
@router.get("/roles", response_model=List[Role])
def get_roles(db: Session = Depends(get_db)):
    """Get all available roles"""
    return user_crud.get_roles(db)
```

**Gi·∫£i th√≠ch:**
- `@router.get("/roles")`: Endpoint GET t·∫°i `/roles`
- `response_model=List[Role]`: Tr·∫£ v·ªÅ danh s√°ch c√°c Role
- **Kh√¥ng y√™u c·∫ßu x√°c th·ª±c** - Kh√¥ng c√≥ `Depends(get_current_active_user)`

**Kh√¥ng c·∫ßn d·ªØ li·ªáu ƒë·∫ßu v√†o** - Ch·ªâ c·∫ßn g·ª≠i GET request

### Lu·ªìng x·ª≠ l√Ω

```python
return user_crud.get_roles(db)
```

**Chi ti·∫øt h√†m get_roles** (t·ª´ `crud/user.py`):
```python
def get_roles(db: Session):
    return db.query(Role).all()  # L·∫•y t·∫•t c·∫£ roles t·ª´ b·∫£ng roles
```

### K·∫øt qu·∫£ tr·∫£ v·ªÅ (List[Role])

**Schema Role** (t·ª´ `schemas/user.py`):
```python
class Role(RoleBase):
    id: int
    authority: str

class RoleBase(BaseModel):
    authority: str
```

**V√≠ d·ª• k·∫øt qu·∫£:**
```json
[
  {
    "id": 1,
    "authority": "owner"
  },
  {
    "id": 2,
    "authority": "tenant"
  },
  {
    "id": 3,
    "authority": "admin"
  }
]
```

**C·∫•u tr√∫c b·∫£ng roles** (t·ª´ `models/user.py`):
```python
class Role(Base):
    __tablename__ = "roles"
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    authority = Column(String(50), unique=True, nullable=False)
    
    users = relationship("User", back_populates="role")
```

---

## üîí ENDPOINT 4: ƒê·ªîI M·∫¨T KH·∫®U

### ƒê·ªãnh nghƒ©a endpoint
```python
@router.patch("/me/password")
async def change_password(
    payload: PasswordChange,
    db: Session = Depends(get_db),
    current_user: UserModel = Depends(get_current_active_user)
):
```

**Gi·∫£i th√≠ch:**
- `@router.patch("/me/password")`: Endpoint PATCH (c·∫≠p nh·∫≠t m·ªôt ph·∫ßn) t·∫°i `/me/password`
- `payload: PasswordChange`: D·ªØ li·ªáu ƒë·ªïi m·∫≠t kh·∫©u t·ª´ client
- `current_user`: User ƒëang ƒëƒÉng nh·∫≠p (c·∫ßn x√°c th·ª±c)

**D·ªØ li·ªáu ƒë·∫ßu v√†o (PasswordChange)** - T·ª´ file `schemas/user.py`:
```python
class PasswordChange(BaseModel):
    old_password: str      # M·∫≠t kh·∫©u hi·ªán t·∫°i (ƒë·ªÉ x√°c th·ª±c)
    new_password: str      # M·∫≠t kh·∫©u m·ªõi
```

**Validation cho new_password** (t·ª± ƒë·ªông):
- T·ªëi thi·ªÉu 8 k√Ω t·ª±
- √çt nh·∫•t 1 ch·ªØ HOA (A-Z)
- √çt nh·∫•t 1 ch·ªØ th∆∞·ªùng (a-z)
- √çt nh·∫•t 1 ch·ªØ s·ªë (0-9)
- √çt nh·∫•t 1 k√Ω t·ª± ƒë·∫∑c bi·ªát (!@#$%...)

**V√≠ d·ª• request body:**
```json
{
  "old_password": "OldPass123!",
  "new_password": "NewPass456@"
}
```

### B∆∞·ªõc 1: X√°c th·ª±c m·∫≠t kh·∫©u hi·ªán t·∫°i

```python
if not verify_password(payload.old_password, current_user.password):
    raise HTTPException(status_code=400, detail="M·∫≠t kh·∫©u hi·ªán t·∫°i kh√¥ng ƒë√∫ng")
```

**Gi·∫£i th√≠ch:**
- D√πng h√†m `verify_password` ƒë·ªÉ ki·ªÉm tra m·∫≠t kh·∫©u c≈© c√≥ ƒë√∫ng kh√¥ng
- So s√°nh `old_password` (plain text) v·ªõi `current_user.password` (ƒë√£ hash)
- N·∫øu kh√¥ng kh·ªõp ‚Üí Tr·∫£ l·ªói **400 Bad Request**

**Chi ti·∫øt h√†m verify_password** (t·ª´ `core/security.py`):
```python
def verify_password(plain_password, hashed_password):
    return pwd_context.verify(plain_password, hashed_password)
```
- D√πng bcrypt ƒë·ªÉ verify
- Bcrypt t·ª± ƒë·ªông tr√≠ch xu·∫•t salt t·ª´ `hashed_password` ƒë·ªÉ so s√°nh

**T·∫°i sao ph·∫£i x√°c th·ª±c m·∫≠t kh·∫©u c≈©?**
- B·∫£o m·∫≠t: ƒê·∫£m b·∫£o ng∆∞·ªùi ƒë·ªïi m·∫≠t kh·∫©u l√† ch√≠nh ch·ªß t√†i kho·∫£n
- N·∫øu ai ƒë√≥ l·∫•y ƒë∆∞·ª£c token nh∆∞ng kh√¥ng bi·∫øt password ‚Üí Kh√¥ng th·ªÉ ƒë·ªïi password

### B∆∞·ªõc 2: Hash v√† c·∫≠p nh·∫≠t m·∫≠t kh·∫©u m·ªõi

```python
current_user.password = get_password_hash(payload.new_password)
db.add(current_user)
db.commit()
```

**Gi·∫£i th√≠ch:**
1. Hash m·∫≠t kh·∫©u m·ªõi b·∫±ng bcrypt (t·∫°o salt m·ªõi t·ª± ƒë·ªông)
2. G√°n m·∫≠t kh·∫©u ƒë√£ hash v√†o `current_user.password`
3. ƒê√°nh d·∫•u object ƒë·ªÉ update (`db.add`)
4. L∆∞u v√†o database (`db.commit`)

**Chi ti·∫øt h√†m get_password_hash** (t·ª´ `core/security.py`):
```python
def get_password_hash(password):
    return pwd_context.hash(password)
```
- D√πng bcrypt ƒë·ªÉ hash
- **T·∫°o salt m·ªõi ng·∫´u nhi√™n** m·ªói l·∫ßn hash
- Tr·∫£ v·ªÅ chu·ªói hash c√≥ format: `$2b$12$salt...hash...`

**L∆∞u √Ω quan tr·ªçng:**
- M·ªói l·∫ßn ƒë·ªïi password s·∫Ω c√≥ **salt m·ªõi**
- Kh√¥ng d√πng l·∫°i salt c≈©
- ƒê√¢y l√† c∆° ch·∫ø b·∫£o m·∫≠t chu·∫©n c·ªßa bcrypt

### B∆∞·ªõc 3: Tr·∫£ k·∫øt qu·∫£

```python
return {"message": "ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng"}
```

**K·∫øt qu·∫£ tr·∫£ v·ªÅ:**
```json
{
  "message": "ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng"
}
```

**Kh√¥ng c√≥ response_model** ‚Üí Tr·∫£ v·ªÅ dict t·ª± do

**Sau khi ƒë·ªïi password:**
- User v·∫´n gi·ªØ JWT token hi·ªán t·∫°i (v·∫´n ƒëƒÉng nh·∫≠p ƒë∆∞·ª£c)
- N·∫øu mu·ªën b·∫Øt user ƒëƒÉng nh·∫≠p l·∫°i ‚Üí C·∫ßn implement th√™m c∆° ch·∫ø blacklist token

---

## üìä S∆† ƒê·ªí LU·ªíNG X·ª¨ L√ù

### LU·ªíNG XEM TH√îNG TIN:
```
1. Client g·ª≠i GET /me v·ªõi JWT token trong header
   ‚Üì
2. get_current_active_user() l·∫•y user t·ª´ token
   ‚Üì
3. Ki·ªÉm tra is_active = true
   ‚Üì
4. Load th√¥ng tin role t·ª´ database (n·∫øu ch∆∞a c√≥)
   ‚Üì
5. Tr·∫£ v·ªÅ th√¥ng tin user ƒë·∫ßy ƒë·ªß
```

### LU·ªíNG C·∫¨P NH·∫¨T TH√îNG TIN:
```
1. Client g·ª≠i PUT /me v·ªõi {fullname?, phone?, email?} + JWT token
   ‚Üì
2. get_current_active_user() l·∫•y user t·ª´ token
   ‚Üì
3. Validation d·ªØ li·ªáu (Pydantic t·ª± ƒë·ªông)
   ‚Üì
4. N·∫øu ƒë·ªïi email ‚Üí Ki·ªÉm tra email m·ªõi ch∆∞a b·ªã tr√πng
   ‚Üì
5. N·∫øu ƒë·ªïi phone ‚Üí Ki·ªÉm tra phone m·ªõi ch∆∞a b·ªã tr√πng
   ‚Üì
6. C·∫≠p nh·∫≠t c√°c field v√†o database
   ‚Üì
7. Tr·∫£ v·ªÅ th√¥ng tin user ƒë√£ c·∫≠p nh·∫≠t
```

### LU·ªíNG XEM ROLES:
```
1. Client g·ª≠i GET /roles
   ‚Üì
2. L·∫•y t·∫•t c·∫£ roles t·ª´ b·∫£ng roles
   ‚Üì
3. Tr·∫£ v·ªÅ danh s√°ch roles
```

### LU·ªíNG ƒê·ªîI M·∫¨T KH·∫®U:
```
1. Client g·ª≠i PATCH /me/password v·ªõi {old_password, new_password} + JWT token
   ‚Üì
2. get_current_active_user() l·∫•y user t·ª´ token
   ‚Üì
3. Validation new_password (t·ªëi thi·ªÉu 8 k√Ω t·ª±, c√≥ ch·ªØ hoa, th∆∞·ªùng, s·ªë, k√Ω t·ª± ƒë·∫∑c bi·ªát)
   ‚Üì
4. verify_password() ki·ªÉm tra old_password c√≥ ƒë√∫ng kh√¥ng
   ‚Üì
5. Hash new_password v·ªõi salt m·ªõi
   ‚Üì
6. C·∫≠p nh·∫≠t password v√†o database
   ‚Üì
7. Tr·∫£ v·ªÅ message th√†nh c√¥ng
```

---

## üîó LI√äN K·∫æT GI·ªÆA C√ÅC FILE

```
users.py (file hi·ªán t·∫°i)
‚îú‚îÄ‚îÄ Import schemas t·ª´: schemas/user.py
‚îÇ   ‚îú‚îÄ‚îÄ User (th√¥ng tin user ƒë·∫ßy ƒë·ªß)
‚îÇ   ‚îú‚îÄ‚îÄ UserUpdate (d·ªØ li·ªáu c·∫≠p nh·∫≠t - optional fields)
‚îÇ   ‚îú‚îÄ‚îÄ Role (th√¥ng tin quy·ªÅn)
‚îÇ   ‚îî‚îÄ‚îÄ PasswordChange (d·ªØ li·ªáu ƒë·ªïi m·∫≠t kh·∫©u)
‚îÇ
‚îú‚îÄ‚îÄ Import CRUD t·ª´: crud/user.py
‚îÇ   ‚îú‚îÄ‚îÄ update_user() - C·∫≠p nh·∫≠t th√¥ng tin user
‚îÇ   ‚îú‚îÄ‚îÄ get_user_by_email() - T√¨m user theo email
‚îÇ   ‚îú‚îÄ‚îÄ get_user_by_phone() - T√¨m user theo phone
‚îÇ   ‚îî‚îÄ‚îÄ get_roles() - L·∫•y t·∫•t c·∫£ roles
‚îÇ
‚îú‚îÄ‚îÄ Import security t·ª´: core/security.py
‚îÇ   ‚îú‚îÄ‚îÄ get_current_active_user() - L·∫•y user t·ª´ JWT token
‚îÇ   ‚îú‚îÄ‚îÄ verify_password() - Ki·ªÉm tra m·∫≠t kh·∫©u c≈©
‚îÇ   ‚îî‚îÄ‚îÄ get_password_hash() - Hash m·∫≠t kh·∫©u m·ªõi
‚îÇ
‚îú‚îÄ‚îÄ Import database t·ª´: core/database.py
‚îÇ   ‚îî‚îÄ‚îÄ get_db() - L·∫•y database session
‚îÇ
‚îî‚îÄ‚îÄ S·ª≠ d·ª•ng models t·ª´: models/user.py
    ‚îú‚îÄ‚îÄ User (as UserModel) - Model b·∫£ng users
    ‚îî‚îÄ‚îÄ Role - Model b·∫£ng roles
```

---

## üóÇÔ∏è C·∫§U TR√öC DATABASE

### B·∫£ng `users`
```python
class User(Base):
    __tablename__ = "users"
    
    owner_id = Column(Integer, primary_key=True, autoincrement=True)
    fullname = Column(String(100), nullable=False)
    phone = Column(String(20), unique=True, nullable=False)       # UNIQUE constraint
    email = Column(String(100), unique=True, nullable=False)      # UNIQUE constraint
    password = Column(String(255), nullable=False)                # M·∫≠t kh·∫©u ƒë√£ hash
    role_id = Column(Integer, ForeignKey("roles.id"), nullable=False)
    is_active = Column(Boolean, default=True)
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    updated_at = Column(DateTime(timezone=True), onupdate=func.now())  # T·ª± ƒë·ªông update
```

**L∆∞u √Ω:**
- `updated_at` t·ª± ƒë·ªông c·∫≠p nh·∫≠t khi c√≥ thay ƒë·ªïi
- `email` v√† `phone` c√≥ UNIQUE constraint ‚Üí Kh√¥ng ƒë∆∞·ª£c tr√πng

---

## üéØ T√ìM T·∫ÆT

### File users.py l√†m g√¨?
1. **GET /me**: Xem th√¥ng tin c√° nh√¢n (c·∫ßn ƒëƒÉng nh·∫≠p)
2. **PUT /me**: C·∫≠p nh·∫≠t th√¥ng tin c√° nh√¢n (c·∫ßn ƒëƒÉng nh·∫≠p)
3. **GET /roles**: Xem danh s√°ch roles (kh√¥ng c·∫ßn ƒëƒÉng nh·∫≠p)
4. **PATCH /me/password**: ƒê·ªïi m·∫≠t kh·∫©u (c·∫ßn ƒëƒÉng nh·∫≠p + m·∫≠t kh·∫©u c≈©)

### D·ªØ li·ªáu ƒë·∫ßu v√†o:
- **GET /me**: Ch·ªâ c·∫ßn JWT token trong header
- **PUT /me**: JWT token + {fullname?, phone?, email?}
- **GET /roles**: Kh√¥ng c·∫ßn g√¨
- **PATCH /me/password**: JWT token + {old_password, new_password}

### D·ªØ li·ªáu tr·∫£ v·ªÅ:
- **GET /me**: Th√¥ng tin user ƒë·∫ßy ƒë·ªß (User schema)
- **PUT /me**: Th√¥ng tin user ƒë√£ c·∫≠p nh·∫≠t (User schema)
- **GET /roles**: Danh s√°ch roles (List[Role])
- **PATCH /me/password**: Message th√†nh c√¥ng

### ƒê·ªçc/Ghi d·ªØ li·ªáu t·ª´ ƒë√¢u?
- **Database**: B·∫£ng `users` v√† `roles`
- **Schemas**: `schemas/user.py` ƒë·ªãnh nghƒ©a c·∫•u tr√∫c d·ªØ li·ªáu
- **Models**: `models/user.py` ƒë·ªãnh nghƒ©a c·∫•u tr√∫c b·∫£ng database
- **CRUD**: `crud/user.py` ch·ª©a logic thao t√°c database
- **Security**: `core/security.py` x·ª≠ l√Ω JWT token, hash/verify password

### B·∫£o m·∫≠t:
- ‚úÖ T·∫•t c·∫£ endpoint (tr·ª´ /roles) y√™u c·∫ßu JWT token
- ‚úÖ Ki·ªÉm tra user is_active tr∆∞·ªõc khi cho ph√©p thao t√°c
- ‚úÖ Ki·ªÉm tra email/phone kh√¥ng tr√πng khi c·∫≠p nh·∫≠t
- ‚úÖ ƒê·ªïi password ph·∫£i nh·∫≠p ƒë√∫ng m·∫≠t kh·∫©u c≈©
- ‚úÖ M·∫≠t kh·∫©u m·ªõi c√≥ validation ch·∫∑t ch·∫Ω
- ‚úÖ M·ªói l·∫ßn ƒë·ªïi password t·∫°o salt m·ªõi (bcrypt t·ª± ƒë·ªông)
- ‚úÖ S·ª≠ d·ª•ng IntegrityError ƒë·ªÉ x·ª≠ l√Ω race condition

### So s√°nh v·ªõi auth.py:
| ƒê·∫∑c ƒëi·ªÉm | auth.py | users.py |
|----------|---------|----------|
| **M·ª•c ƒë√≠ch** | ƒêƒÉng nh·∫≠p/ƒêƒÉng k√Ω | Qu·∫£n l√Ω th√¥ng tin user |
| **X√°c th·ª±c** | T·∫°o JWT token | S·ª≠ d·ª•ng JWT token |
| **T·∫°o user** | ‚úÖ (register) | ‚ùå |
| **C·∫≠p nh·∫≠t user** | ‚ùå | ‚úÖ (update profile) |
| **ƒê·ªïi password** | ‚ùå | ‚úÖ (change password) |
| **Y√™u c·∫ßu ƒëƒÉng nh·∫≠p** | ‚ùå | ‚úÖ (tr·ª´ /roles) |

